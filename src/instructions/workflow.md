# OMCC 工作流指南

## 角色分工

| 角色 | 定位 | 用途 | 沙箱模式 | 默认重试 |
|------|------|------|----------|----------|
| **Coder** | 代码执行者 | 生成/修改代码、批量任务 | workspace-write | 0 |
| **Reviewer** | 代码审核者 | 代码 Review、质量把关 | read-only | 1 |
| **Advisor** | 高阶顾问 | 架构设计、第二意见 | workspace-write | 1 |
| **Frontend** | 前端/UI 专家 | 界面设计、样式动效 | workspace-write | 1 |
| **Chore** | 杂务执行者 | 批量操作、格式化 | workspace-write | 0 |
| **Researcher** | 研究专家 | 文档查询、网络搜索 | read-only | 1 |
| **Looker** | 多模态分析 | PDF/图片/图表分析 | read-only | 1 |

## 代理选择指南

```
用户需求
    │
    ├─ 代码改动 ──────────────────┬─ 复杂功能实现 → Coder
    │                            ├─ 前端/UI 开发 → Frontend
    │                            └─ 简单批量操作 → Chore
    │
    ├─ 代码审核 ─────────────────── Reviewer
    │
    ├─ 研究/咨询 ────────────────┬─ 架构设计/第二意见 → Advisor
    │                            └─ 网络研究 → Researcher
    │
    └─ 文件分析 ─────────────────── PDF/图片/图表 → Looker
```

## 核心流程

### 1. 选择代理

根据任务类型选择合适的代理。

### 2. 编写 Prompt

> ⚠️ **一次调用，一个目标**。禁止向代理堆砌多个不相关需求。

**Prompt 核心要素**：
- **任务目标**：一句话说明要完成什么
- **背景上下文**：技术栈、相关文件、参考实现
- **具体步骤**：分步骤列出要做的事情
- **约束条件**：不要修改的文件、必须遵守的规则
- **潜在陷阱**：你知道的可能出问题的地方
- **交付标准**：可验证的完成检查点

### 3. 执行与验收

```
代理执行 → 主代理验收 → 有误则修复 → 阶段性完成后 Reviewer 审核
```

### 4. Reviewer 审核

阶段性开发完成后调用 Reviewer：
- ✅ 通过：继续下一阶段
- ⚠️ 优化：委托修复后继续
- ❌ 修改：必须修复后重新审核

## 会话管理

**SESSION_ID 规范**：
- 必须保存返回的 `SESSION_ID`
- 后续请求中携带以保持上下文
- 各角色的 SESSION_ID 相互独立
- 严禁自创 ID 或混用不同角色的 ID

## 使用示例

### 调用 Coder 执行代码任务

```bash
omcc coder --cd /path/to/project "
**任务目标**：实现用户登录功能

**目标文件**：src/auth/login.ts

**具体要求**：
1. 创建登录表单组件
2. 实现登录 API 调用
3. 处理登录状态

**交付标准**：
- [ ] 登录表单正常渲染
- [ ] API 调用成功返回 token
- [ ] 错误处理完善
"
```

### 调用 Reviewer 审核代码

```bash
omcc reviewer --cd /path/to/project "
请 review 以下代码改动：

**改动文件**：src/auth/login.ts
**改动目的**：实现用户登录功能

**请检查**：
1. 代码质量
2. 潜在 Bug
3. 需求完成度
"
```

### 调用 Researcher 查询文档

```bash
omcc researcher --cd /path/to/project "
请查询 React useEffect 的最佳实践，
特别是清理副作用的正确方式。
"
```

## CLI 参数速查

| 参数 | 简写 | 说明 |
|------|------|------|
| `--cd` | `-C` | 工作目录 |
| `--sandbox` | `-s` | 沙箱策略 |
| `--session-id` | `-S` | 会话 ID |
| `--timeout` | `-t` | 空闲超时（秒）|
| `--max-duration` | `-d` | 最大执行时长（秒）|
| `--max-retries` | `-r` | 最大重试次数 |
| `--model` | `-m` | 指定模型 |
| `--stdin` | `-i` | 从 stdin 读取提示词 |
| `--file` | `-f` | 从文件读取提示词 |
| `--json` | `-j` | JSON 格式输出 |
